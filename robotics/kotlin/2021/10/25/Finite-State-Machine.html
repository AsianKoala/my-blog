<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Finite State Machines | Neil Mehra</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Finite State Machines" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to utilize Finite State Machines in Part 1" />
<meta property="og:description" content="Learn how to utilize Finite State Machines in Part 1" />
<link rel="canonical" href="https://asiankoala.github.io/my-blog/robotics/kotlin/2021/10/25/Finite-State-Machine.html" />
<meta property="og:url" content="https://asiankoala.github.io/my-blog/robotics/kotlin/2021/10/25/Finite-State-Machine.html" />
<meta property="og:site_name" content="Neil Mehra" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-25T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2021-10-25T00:00:00-05:00","url":"https://asiankoala.github.io/my-blog/robotics/kotlin/2021/10/25/Finite-State-Machine.html","@type":"BlogPosting","dateModified":"2021-10-25T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://asiankoala.github.io/my-blog/robotics/kotlin/2021/10/25/Finite-State-Machine.html"},"headline":"Finite State Machines","description":"Learn how to utilize Finite State Machines in Part 1","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/my-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://asiankoala.github.io/my-blog/feed.xml" title="Neil Mehra" /><link rel="shortcut icon" type="image/x-icon" href="/my-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/my-blog/">Neil Mehra</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/my-blog/about/">About Me</a><a class="page-link" href="/my-blog/search/">Search</a><a class="page-link" href="/my-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Finite State Machines</h1><p class="page-description">Learn how to utilize Finite State Machines in Part 1</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-25T00:00:00-05:00" itemprop="datePublished">
        Oct 25, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/my-blog/categories/#Robotics">Robotics</a>
        &nbsp;
      
        <a class="category-tags-link" href="/my-blog/categories/#Kotlin">Kotlin</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#defining-our-expectations">Defining our expectations</a></li>
<li class="toc-entry toc-h2"><a href="#implementation-kotlin">Implementation (Kotlin)</a></li>
</ul><p>A common problem new programmers face in robotics is running a several complex seriesof actions asynchrounously. Finite state machines (FSMs) are often used to solvethis. FSMs are literally as they sound: machines that have states. At any time, the FSM runs a single state. On completion of this state, this FSM will iterate to the next state. This repeats until the last state in the FSM has been completed.</p>

<h2 id="defining-our-expectations">
<a class="anchor" href="#defining-our-expectations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining our expectations</h2>
<p>In each stage of the program, the FSM needs to know the current state and actionto run. Furthermore, the FSM should know when to transition to the next stage, as well as running an action during these transitions. To reiterate:</p>

<ol>
  <li>Transition to stage N</li>
  <li>Stage N-1 exit action runs</li>
  <li>Stage N enter action runs</li>
  <li>Stage N loop action runs</li>
  <li>Check if stage N should transition</li>
  <li>If true, run stage N exit action, transition, and run stage N+1 enter action</li>
</ol>

<ul>
  <li>
    <p>Implementation wise, we want to instantiate a FSM without too much effort. The easiest way to construct a dynamic object is with the builder pattern.</p>
  </li>
  <li>
    <p>Having several actions would be nice as well, so actions for each stage should be held in lists.</p>
  </li>
  <li>
    <p>To be as flexible as possible, the FSM should have the ability to stop or reset at any time.</p>
  </li>
  <li>
    <p>Transitions should easily implement a timer based system for timed transitions</p>
  </li>
</ul>

<h2 id="implementation-kotlin">
<a class="anchor" href="#implementation-kotlin" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementation (Kotlin)</h2>
<p>To implement these requirements, we will follow my state machine library writtenin Kotlin. I took inspiration for the library from <a href="https://github.com/NoahBres/jotai">@NoahBres’s Jotai library</a>.</p>

<p>First, lets implement an “action”. An action should be a single function that simply runs. In Kotlin, the easiest method of writing such a requirement is to usea Functional SAM (Single Abstract Method) Interface.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun interface Action {
	fun run()
}
</code></pre></div></div>

<p>We can now pass this action interface into functions to invoke the run() method,
similar to how a lambda functions. Functional interfaces in kotlin have special syntax</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun runAction(myAction: Action) {
	myAction.run()
}

runAction { println("Hello World!" }
</code></pre></div></div>

<p>Now let us define a similar functional interface for transitioning between states. The state machine will repeatedly check the transition condition to see if the current state is finished, meaning we need a method returning a boolean.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun interface Transition {
	fun shouldTransition(): Boolean
}

</code></pre></div></div>

<p>Similarly to <code class="language-plaintext highlighter-rouge">Action</code>, <code class="language-plaintext highlighter-rouge">Transition</code> can also use functional interface syntax.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun printShouldTransition(t: Transition) {
	print(t.shouldTransition())
}
val t = { true }
printShouldTransition(t)
</code></pre></div></div>
<blockquote>
  <p>returns true</p>
</blockquote>

<p>Now we have enough to define a “State”. Referring back to our definitions of a state, we need to have lists of actions for each stage of the state, as well as atransition condition. Each state should have an Enum associated with it, as thiswill simplify writing code. Data classes in Kotlin serve this need well, as theypregenerate some useful functions. Specific actions should be ran when entering the state, when looping before transitioning, and then on transition.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data class State&lt;T&gt; {
	var state: T,
	var onEnter: MutableList&lt;Action&gt;,
	var onLoop: MutableList&lt;Action&gt;,
	var onExit: MutableList&lt;Action&gt;,
	var transition: TransitionCondition = { true }
|
</code></pre></div></div>

<p>Notice I defaulted the transition variable to a value of true. This is personal preference, as if I have a state with no transition condition I want the state machine to assume the state is finished. If you don’t want this feature, requiring that a state has a transition condition when building the state machine is an easy addition that I will elaborate on later.</p>

<p>Now that we have classes for Actions, Transitions, and States, all that is left is to write the main StateMachine logic and the StateMachineBuilder class utilizng the builder pattern for ease of use.</p>

<p>I will skim over some details of my StateMachine class with psuedocode, as the main class is fairly trivial. If you wish to read my StateMachine code, it is available <a href="https://github.com/14607/FF-Private/blob/master/TeamCode/src/main/java/robotuprising/koawalib/statemachine/StateMachine.kt">here</a>.</p>

<p>The header of the StateMachine class is standard. Each state machine has a generic associated with it, which will be supplied on creation of a StateMachine object as an enum, and a list of states.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class StateMachine&lt;T&gt;(private val stateList: List&lt;State&lt;T&gt;&gt;) {
...
}
</code></pre></div></div>

<p>Having the state machine running at all times would be harmful so a <code class="language-plaintext highlighter-rouge">running</code> variable would be useful, as well as a <code class="language-plaintext highlighter-rouge">currentState</code> variable to save the current state we are running in <code class="language-plaintext highlighter-rouge">stateList</code>. Current state can be either an indice value (so, an integer) or a “T”, but that is up to the reader to decide. There’s no real benefit besides whatever is easier to you.</p>

<p>Next, lets define what the state machine does when it starts. On start, the running variable should be set to true, and all enter actions of the current state should run. Note that current state does not necessarily denote the first state to run; a state machine can be stopped and started at any phase while traversing the stateList.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fun start() {
	running = true
	currentAction.enterActions(Action::run)
}
</code></pre></div></div>

<p>Our next function, update() is also fairly straightforward. Update is called periodicly while the state machine is running. It first checks if the currentState’s transition condition is true, and if so, transitions. If the state machine has stopped running (running == false), it returns and stops the update() function. After these 2 checks, it runs all the loopActions of the currentState. I’ll leave the implementation up to the reader for this one.</p>

<p>The last function of the StateMachine class is our transition() function. This is called when the currentState’s transition condition is true in the update() method. The function first runs all the exitActions of the currentState, and then sets currentState = to the next state in stateList. As I implemented currentState to be <t>, I used stateList.indexOf(currentState) to find the current state in the stateList, but currentState as an index would simply be currentState++. Then, we run all the enterActions of the newState, which is our currentState.</t></p>

<p>And that’s it! You can now use your StateMachine class to program complicated movements on your robots that might’ve otherwise taken hours of frustration in a much shorter timeframe. I’ll soon write a post on how to implement the builder method to quickly create a stateList effortlessly. In the meanwhile, I’ll add a small code snippet displaying how the builder pattern works in my state machine implementation. Good luck!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val IntakeEnum {
	ON,
	CHECKING_FOR_MINERAL,
	OFF
}

val intakeStateMachine = StateMachineBuilder&lt;IntakeEnum&gt;()
	.state(ON)
	.onEnter(intake::turnOn)
	.transition { true }
	
	.state(CHECKING_FOR_MINERAL)
	.transition(sensor::isMineralIn)

	.state(OFF)
	.onEnter(intake::turnOff)
	.transition { true }
	
	.build()
</code></pre></div></div>


  </div><a class="u-url" href="/my-blog/robotics/kotlin/2021/10/25/Finite-State-Machine.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/my-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/my-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/my-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" target="_blank" title="fastai"><svg class="svg-icon grey"><use xlink:href="/my-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" target="_blank" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/my-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
